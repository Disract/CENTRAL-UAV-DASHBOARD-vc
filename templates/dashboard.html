<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UAV Command & Control System</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/command.css') }}">
  
  <style>
    /* ORB-SLAM Video Feeds */
    .video-grid, .video-display-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 100%;
    }
    .feed-box {
      position: relative;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      aspect-ratio: 16/9;
    }
    .feed-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    .feed-box .feed-label {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(0,0,0,0.7);
      color: #0f0;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 3px;
      font-family: monospace;
      z-index: 10;
      border: 1px solid #0f0;
    }
    .feed-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    
    /* Modal video feeds - larger */
    .video-display-grid {
      min-height: 70vh;
    }
    .modal-feed {
      aspect-ratio: 16/9;
      height: auto;
    }
    
    /* Make video section clickable */
    .status-section h4 {
      cursor: pointer;
      user-select: none;
    }
    .status-section h4:hover {
      opacity: 0.8;
    }
    
    /* Connection indicator */
    .feed-status {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f00;
      z-index: 10;
    }
    .feed-status.connected {
      background: #0f0;
      box-shadow: 0 0 8px #0f0;
    }
  </style>
</head>
<body class="command-interface" data-theme="day">
  <!-- Top Command Bar -->
  <header class="command-header">
    <div class="header-left">
      <span class="system-title">UAV COMMAND & CONTROL SYSTEM</span>
      <span class="classification">UNCLASSIFIED</span>
    </div>
    <div class="header-center">
      <span class="mission-name" id="current-mission">OPERATION OVERWATCH</span>
      <span class="system-time" id="system-time"></span>
    </div>
    <div class="header-right">
      <div class="connection-status">
        <span class="status-label">COMMS:</span>
        <span class="status-value" id="comm-status">SECURE</span>
      </div>
      <div class="user-info">
        <span class="user-role">{{ user.role.value.upper() if user else 'OPERATOR' }}</span>
        <span class="user-name">{{ user.name if user else 'UNKNOWN' }}</span>
      </div>
      <button class="btn-command" id="theme-toggle">DAY/NIGHT</button>
      <a href="{{ url_for('logout') if user else '#' }}" class="btn-command">LOGOUT</a>
    </div>
  </header>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Left Panel: UAV Status -->
    <div class="panel panel-left">
      <div class="panel-header">
        <h3>UAV STATUS</h3>
        <div class="panel-controls">
          <span class="active-count">ACTIVE: <span id="active-uavs">0</span></span>
          <button class="btn-panel" id="refresh-uavs">REFRESH</button>
        </div>
      </div>
      <div class="panel-content" id="uav-list">
        <!-- UAV cards will be populated here -->
      </div>
    </div>

    <!-- Center Panel: Map -->
    <div class="panel panel-center">
      <div class="panel-header">
        <h3>TACTICAL DISPLAY</h3>
        <div class="panel-controls">
          <div class="control-group">
            <button class="btn-panel" id="center-map">CENTER</button>
            <button class="btn-panel" id="toggle-paths">PATHS</button>
            <select class="select-panel" id="map-layer">
              <option value="satellite">SATELLITE</option>
              <option value="terrain">TERRAIN</option>
              <option value="street">STREET</option>
            </select>
          </div>
        </div>
      </div>
      <div class="map-container">
        <div id="map" class="tactical-map"></div>
        <div class="map-overlay">
          <div class="coordinates" id="mouse-coords">LAT: 0.000000 LON: 0.000000</div>
        </div>
      </div>
    </div>

    <!-- Right Panel: Mission Log -->
    <div class="panel panel-right">
      <div class="panel-header">
        <h3>MISSION LOG</h3>
        <div class="panel-controls">
          <button class="btn-panel" id="clear-log">CLEAR</button>
          <button class="btn-panel" id="export-log">EXPORT</button>
        </div>
      </div>
      <div class="panel-content">
        <div class="log-container" id="mission-log">
          <!-- Mission log entries will be populated here -->
        </div>
      </div>
    </div>

    <!-- Bottom Panel: System Status -->
    <div class="panel panel-bottom">
      <div class="status-grid">
        <div class="status-section">
          <h4>ALERTS</h4>
          <div class="alert-container" id="alert-container">
            <div class="alert-item alert-info">SYSTEM OPERATIONAL</div>
          </div>
        </div>
        <div class="status-section">
          <h4>COMMUNICATIONS</h4>
          <table class="status-table">
            <tr><td>ENCRYPTION:</td><td class="status-active">AES-256</td></tr>
            <tr><td>NETWORK:</td><td class="status-active">SECURE</td></tr>
            <tr><td>GPS:</td><td class="status-active">LOCKED</td></tr>
          </table>
        </div>
        <div class="status-section">
          <h4 id="video-feeds-header" style="cursor: pointer;" title="Click to expand">VIDEO FEEDS <i class="fas fa-expand-alt" style="font-size: 12px;"></i></h4>
          <div class="video-grid" id="video-feeds">
            <div class="feed-box">
              <div class="feed-status" id="status-0"></div>
              <span class="feed-label">STREAM 1</span>
              <img id="stream-0" class="feed-video" alt="Stream 1">
            </div>
            <div class="feed-box">
              <div class="feed-status" id="status-1"></div>
              <span class="feed-label">STREAM 2</span>
              <img id="stream-1" class="feed-video" alt="Stream 2">
            </div>
            <div class="feed-box">
              <div class="feed-status" id="status-2"></div>
              <span class="feed-label">STREAM 3</span>
              <img id="stream-2" class="feed-video" alt="Stream 3">
            </div>
            <div class="feed-box">
              <div class="feed-status" id="status-3"></div>
              <span class="feed-label">STREAM 4</span>
              <img id="stream-3" class="feed-video" alt="Stream 4">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- UAV Detail Modal -->
  <div class="modal fade" id="uavModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content command-modal">
        <div class="modal-header">
          <h5 class="modal-title">UAV DETAILED STATUS</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="uav-modal-body">
          <!-- UAV details will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Video Feed Modal -->
  <div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content command-modal">
        <div class="modal-header">
          <h5 class="modal-title">LIVE VIDEO FEEDS - ORB-SLAM TRACKING</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="video-display-grid" id="video-display">
            <div class="feed-box modal-feed">
              <div class="feed-status connected" id="modal-status-0"></div>
              <span class="feed-label">STREAM 1</span>
              <img id="modal-stream-0" class="feed-video" alt="Stream 1">
            </div>
            <div class="feed-box modal-feed">
              <div class="feed-status connected" id="modal-status-1"></div>
              <span class="feed-label">STREAM 2</span>
              <img id="modal-stream-1" class="feed-video" alt="Stream 2">
            </div>
            <div class="feed-box modal-feed">
              <div class="feed-status connected" id="modal-status-2"></div>
              <span class="feed-label">STREAM 3</span>
              <img id="modal-stream-2" class="feed-video" alt="Stream 3">
            </div>
            <div class="feed-box modal-feed">
              <div class="feed-status connected" id="modal-status-3"></div>
              <span class="feed-label">STREAM 4</span>
              <img id="modal-stream-3" class="feed-video" alt="Stream 4">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Custom JavaScript -->
  <script src="{{ url_for('static', filename='js/command.js') }}"></script>

  <!-- ORB-SLAM Video Feeds JavaScript -->
  <script>
    (function() {
      console.log("[VIDEO] Initializing ORB-SLAM video feed handler...");
      
      // Connect to Socket.IO server
      const socket = io();
      
      // Track connection status
      let isConnected = false;
      const frameTimestamps = [0, 0, 0, 0]; // Track last frame time for each stream
      
      socket.on("connect", () => {
        console.log("✅ [VIDEO] Connected to server");
        isConnected = true;
        updateConnectionStatus();
      });
      
      socket.on("disconnect", () => {
        console.warn("⚠️ [VIDEO] Disconnected from server");
        isConnected = false;
        updateConnectionStatus();
      });
      
      // Handle incoming video frames
      socket.on("frame", (payload) => {
        const { id, image } = payload;
        
        if (id < 0 || id > 3) {
          console.error(`[VIDEO] Invalid stream id: ${id}`);
          return;
        }
        
        // Update timestamp for this stream
        frameTimestamps[id] = Date.now();
        
        // Update status indicators
        const statusEl = document.getElementById(`status-${id}`);
        const modalStatusEl = document.getElementById(`modal-status-${id}`);
        if (statusEl) statusEl.classList.add('connected');
        if (modalStatusEl) modalStatusEl.classList.add('connected');
        
        // Update small preview feed
        const smallFeed = document.getElementById(`stream-${id}`);
        if (smallFeed) {
          smallFeed.src = image;
        }
        
        // Update modal feed
        const modalFeed = document.getElementById(`modal-stream-${id}`);
        if (modalFeed) {
          modalFeed.src = image;
        }
      });
      
      // Update connection status indicators
      function updateConnectionStatus() {
        for (let i = 0; i < 4; i++) {
          const statusEl = document.getElementById(`status-${i}`);
          const modalStatusEl = document.getElementById(`modal-status-${i}`);
          
          if (isConnected) {
            if (statusEl) statusEl.classList.add('connected');
            if (modalStatusEl) modalStatusEl.classList.add('connected');
          } else {
            if (statusEl) statusEl.classList.remove('connected');
            if (modalStatusEl) modalStatusEl.classList.remove('connected');
          }
        }
      }
      
      // Check for stale feeds (no frames in 5 seconds)
      setInterval(() => {
        const now = Date.now();
        for (let i = 0; i < 4; i++) {
          if (frameTimestamps[i] > 0 && (now - frameTimestamps[i]) > 5000) {
            const statusEl = document.getElementById(`status-${i}`);
            const modalStatusEl = document.getElementById(`modal-status-${i}`);
            if (statusEl) statusEl.classList.remove('connected');
            if (modalStatusEl) modalStatusEl.classList.remove('connected');
          }
        }
      }, 1000);
      
      // Click on "VIDEO FEEDS" header to open modal
      const videoHeader = document.getElementById('video-feeds-header');
      if (videoHeader) {
        videoHeader.addEventListener('click', () => {
          const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
          videoModal.show();
          console.log("[VIDEO] Opened full-screen video modal");
        });
      }
      
      // Also allow clicking the video grid itself
      const videoGrid = document.getElementById('video-feeds');
      if (videoGrid) {
        videoGrid.addEventListener('click', () => {
          const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
          videoModal.show();
          console.log("[VIDEO] Opened full-screen video modal");
        });
      }
      
      console.log("[VIDEO] Video feed handler initialized");
    })();
  </script>
</body>
</html>